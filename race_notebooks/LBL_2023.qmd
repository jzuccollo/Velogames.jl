---
title: Velogames Liège-Bastogne-Liège 2023 solver
date: 23/04/2023
format:
  html:
    code-fold: true
jupyter: julia-1.8
---

# Velogames solver: Liège-Bastogne-Liège 2023

## Load libraries

```{julia}
using Gadfly, Velogames
```

## Retrieve data

Data is scraped from the [Velogames website](https://www.velogames.com/). Rider scores are the number of points they have accumulated in the current season.

```{julia}
rider_vg = getvgriders("https://www.velogames.com/spring-classics/2023/riders.php")

# keep only riders in the startlist for LBL.
rider_vg = rider_vg[rider_vg.startlist.=="#LiegeBastogneLiege", :]

rider_oneday = getpcsranking(:oneday)
```

Combine datasets and calculate rider value.

```{julia}
rider_df = leftjoin(rider_vg, rider_oneday, on=:riderkey, makeunique=true)

# rename points to vgpoints
rename!(
    rider_df,
    :points => :vgpoints,
    :cost => :vgcost,
    :rank => :pcsrank,
    :points_1 => :pcspoints
)
# drop columns ending in _1
select!(rider_df, Not([:rider_1, :team_1]))

# fill in missing values in rank and points with 0
rider_df[ismissing.(rider_df.pcsrank), :pcsrank] .= 0
rider_df[ismissing.(rider_df.pcspoints), :pcspoints] .= 0
# calculate rider calc_score as the mean of the velogames score and the PCS score
rider_df[!, :calc_score] = (rider_df.pcspoints .+ rider_df.vgpoints) ./ 2
# # calculate rider value as the ratio of rider score to rider cost
rider_df[!, :calc_value] = rider_df.calc_score ./ rider_df.vgcost

rider_df
```

## Inspect the data

### Top 10 riders by points

```{julia}
sort(rider_df, :calc_score, rev=true)[1:10, :]
```

### Top 10 riders by value

```{julia}
sort(rider_df, :calc_value, rev=true)[1:10, :]
```

```{julia}
plot(
    rider_df,
    x=:calc_score,
    y=:cost,
    Guide.xlabel("Score"),
    Guide.ylabel("Cost"),
    Guide.title("Rider value")
)
```

## Build the model

```{julia}
model_results = build_model_oneday(rider_df)
```

## Results

### Total cost of team

Must be no more than 100.

```{julia}
# total cost
rider_df.vgcost .* model_results.data |> sum
```

### Selected riders

```{julia}
# selected riders
rider_df[!, :chosen] = model_results.data .|> !iszero
chosen_team = filter(:chosen => ==(true), rider_df)
chosen_team[:, [:rider, :team, :vgcost, :vgpoints, :pcspoints, :pcsrank, :calc_score, :calc_value]]
```

